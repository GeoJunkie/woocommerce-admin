name: 'Daily Tests'

on:
  pull_request:
  schedule:
    - cron:  '0 0 * * *'

jobs:
    test-php:
        name: "Test PHP"
        runs-on: ubuntu-18.04
        strategy:
            fail-fast: false
            matrix:
                wordpress: ['latest', 'nightly']
                woocommerce: ['latest', 'nightly']
        steps:
            - name: Check out repository code
              uses: actions/checkout@v2
            - name: Setup Node.js
              uses: actions/setup-node@v2-beta
              with:
                  node-version: '14'
            - name: Build
              run: |
                  npm run build:feature-config	
                  composer install  --no-dev
              shell: bash
            - name: Run the PHP unit tests
              env:
                  WP_VERSION: ${{ matrix.woocommerce }}
                  WC_VERSION: ${{ matrix.woocommerce }}

              run: npm run test:php
              shell: bash

      e2e-tests:
        runs-on: ubuntu-18.04
        steps:
            - name: Check out repository code
              uses: actions/checkout@v2
            - name: Setup PHP
              uses: shivammathur/setup-php@2.9.0
              with:
                  php-version: '7.3'
            - name: Install PHP dependencies
              run: |
                  composer i
            - name: Setup Node.js
              uses: actions/setup-node@v2-beta
              with:
                  node-version: '14'
            - name: Build
              env:
                  WP_VERSION: latest
                  WP_MULTISITE: 0
                  WP_CORE_DIR: /tmp/wordpress
                  RUN_E2E: 1
              run: |
                  npm i
                  composer require wp-cli/i18n-command
                  npm run build
                  npm install jest --global
                  WP_VERSION=5.6.2
                  npx wc-e2e docker:up
                  npx wc-e2e test:e2e
