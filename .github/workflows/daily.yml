name: 'Daily Tests'

on:
  pull_request:
  schedule:
    - cron:  '0 0 * * *'

jobs:
    test-php:
        name: "Test PHP"
        runs-on: ubuntu-18.04
        strategy:
            fail-fast: false
            matrix:
                wordpress: ['latest', 'nightly']
                woocommerce: ['latest', 'nightly']
        steps:
            - name: Check out repository code
              uses: actions/checkout@v2
            - name: Setup Node.js
              uses: actions/setup-node@v2-beta
              with:
                  node-version: '14'
            - name: Build
              run: |
                  npm run build:feature-config	
                  composer install  --no-dev
              shell: bash
            - name: Run the PHP unit tests
              env:
                  WP_VERSION: ${{ matrix.woocommerce }}
                  WC_VERSION: ${{ matrix.woocommerce }}

              run: npm run test:php
              shell: bash

    e2e-tests:
        runs-on: ubuntu-18.04
        steps:
            - name: Check out repository code
              uses: actions/checkout@v2
            - name: Install PHP dependencies
              run: |
                  composer install  --no-dev
            - name: Setup Node.js
              uses: actions/setup-node@v2-beta
              with:
                  node-version: '14'
            - name: Build
              run: |
                  npm i
                  composer require wp-cli/i18n-command
                  npm run build:feature-config
                  npm run build
            - name: Setup wp-env
              run: |
                  npm -g i @wordpress/env
                  WP_ENV_TESTS_PORT=8084 wp-env start
                  wp-env run tests-cli "wp post create --post_type=page --post_status=publish --post_title='Ready' --post_content='E2E-tests.'"
            - name: Test
              run: |
                  npm run test:e2e
